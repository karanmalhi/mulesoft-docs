= Installing Anypoint Platform On Premises Edition
:keywords:anypoint platform, on premises
// insert link to Mule agent installation file on line 319

== Assumptions

This page assumes you have at least a basic understanding of Unix-based systems and networking, and are familiar with the command line. You should also be familiar with link:http://rancher.com/rancher/[Rancher] and link:https://docs.docker.com/installation/[Docker].



== Overview

Anypoint Platform is available to download and install on premise by obtaining the installation ZIP file from MuleSoft. Currently, Anypoint Platform on-premises Edition is run via link:https://docs.docker.com/installation/[Docker], an open-source virtualization platform, and link:http://rancher.com/rancher/[Rancher] is also used to run Docker containers in production. Docker uses _containers_ to wrap applications in a complete filesystem with everything needed to run, including runtime and configuration data. MuleSoft provides Docker images that contain the different components of Anypoint Platform on-premises Edition – complete with configuration – which you can run on Docker.

Docker runs natively on Linux, but you can use it on OS X and Windows via a Linux virtual machine. You can create your own virtual machine with a Linux distribution supported by Docker, or download and use Docker Toolbox, which contains both Docker Machine and Docker Compose. Docker Machine works as a wrapper around a virtual Linux machine on which Docker runs.

This document contains a brief section to provide orientation on installing Docker on your operating system, and complete instructions for downloading and running the Anypoint Platform on your Docker container.

With Rancher you have the ability to run as many copies of each stateless service as you want and Rancher will automatically balance them between registered hosts. That being said, you will only want to have 1 instance of the singleton services (databases, objectstore, mcm).  For example, if you have 3 hosts registered and you want to run 2 copies of each service, then Rancher will automatically determine which hosts should run each service.

image:rancher-struct.png[rancher struct]


=== System Requirements

*Disk space*: > 30GB free disk space on every host that will run MuleSoft software

*OS Requirements*: Ubuntu is recommended, as it has been tested extensively. Redhat and CentOS have not been tested yet, but are believed to work as well.

*Server vs Agent Hosts*: In theory you can run the Rancher Server, Rancher Agent, and all MuleSoft images on the same machine.  However, we have run into some issues such as port conflicts, exceeding the number of AUFS mounted layers, etc.  To be safe we recommend installing the Rancher Server on one host and then the Rancher Agent and MuleSoft images on other hosts.

*Ports*: Rancher and the MuleSoft software make use of the following ports, so verify that they are open:

* *UDP*: 500, 4500
* *TCP*: 80, 443, 8080, 8443

*You will need to install the following components on each host*:

* docker engine
* docker-compose
* rancher-compose (cli for working with rancher tools)

[WARNING]
You need to have Docker version 1.8.x. Docker 1.9.X isn't currently compatible with this installation.

Follow the docker installation instructions that are appropriate for your system.   https://docs.docker.com/installation/

=== Dowload Script Bundle

Depending on what you wish to install, download one of the following two bundles of configuration files and scripts:

* link:_attachments/anypoint-platform.zip[Anypoint Platform On Premsies]: For installing the entire functionality of the Anypoint Platform, including API administration tools.
* link:_attachments/anypoint-runtime-manager.zip[Anypoint Runtime Manager On Premsies]: For installing the reduced verison of the Anypoint Platform, limited only to the Runtime Manager, which manages your deployed applications.

These .zip files contain all of the configuration and installation scripts needed to run Anypoint Platform or Anypoint Runtime Management.

=== Architecture of Anypoint Platform on Docker

[TIP]
For a more detailed explanation of Docker, see the link:https://docs.docker.com/introduction/understanding-docker/[Docker documentation].

Docker uses a server-client architecture. It runs as a daemon on a Linux host, where the docker _images_ are stored. A docker image is a template that contains an environment and applications. Using a client application, you tell the Docker daemon to run a _container_ from a specific image. A container is a virtual operating system, built at runtime from the template provided by the image you specified. The container runs the image's applications, for example a Web server.

Anypoint Platform on premise is a _multi-container application_, i.e. its modules occupy more than one container. Anypoint Platform uses https://docs.docker.com/compose/[Docker Compose], a tool that allows you to bring up or shut down a multi-container application with a single command. If you're using the Docker Toolbox, it already includes Docker Compose in it.

To run Anypoint Platform on premise, you need to:

* Install Docker v1.6 or later, natively or on a virtual machine
* Install Docker Compose
* Subscribe and login to the MuleSoft Docker repo, to download the Docker images for Anypoint Platform
* Run Anypoint Platform
* Run a command to seed the authentication database with an initial set of users
* Login to Anypoint Platform

These steps are detailed below.

== Installing Docker and Rancher

link:http://www.docker.com[Docker] runs natively on Linux, including Debian, Ubuntu, Red Hat, CentOS, Oracle and others.

Docker can also run on OS X (10.6 "Snow Leopard" and above) and Windows (7 and 8.1) using Docker Toolbox. However, we only recommend using Mac or Windows for demonstration purposes. The links to download instructions for OS X and Windows use Docker Toolbox.

Instructions for installing Docker:

* link:https://docs.docker.com/installation/[Linux] (check the link for supported distributions)
* link:https://docs.docker.com/installation/mac/[OS X] (10.6 "Snow Leopard" and above)
* link:https://docs.docker.com/installation/windows/[Windows] (7 and 8.1)

Other resources:

* link:https://docs.docker.com/userguide/[Docker User Guide]

=== Installing Docker Compose

Please follow the instructions listed on link:https://docs.docker.com/compose/install/[Docker Compose install]


<<<<<<< HEAD

==== Copy platform config files to `/opt/config`

The Anypoint platform configuration files must be in a predictable location on each host machine because Rancher dynamically launches services on any available host.  This means that it won’t have the benefit of finding config files from a current working directory the same way docker-compose would.  `/opt/config` has been chosen as the default directory to store platform configuration files, so what you need to do is download the link:[I STILL NEED THE FILE TO PUT HERE] and copy the config directory into the `/opt` folder.  Repeat this procedure on every host you register to Rancher.

[source]
----
> cd anypoint-platform
> sudo cp -r config /opt/.
----

==== Rancher Server Installation:

Run the rancher server on the machine you designate to host it.  It occupies a single docker container.

[source]
----
> sudo docker run -v /opt/anypoint-platform/config/logos/:/usr/share/cattle/war/assets/images/logos -d --restart=always -p 9999:8080 rancher/server
----

After a few minutes, the server will be running and will allow you to access the UI on your browser of choice vía HTTP:  `http://$SERVER_IP:9999`

image:rancher-welcome.png[rancher welcome]

You now have the server up and running with the Rancher UI. From here onwards, this tutorial will make use of the Rancher UI instead of the terminal to manage the installation.

==== Register a host with the rancher server:

Follow the Docker instructions above on a separate machine. This machine will be used as a host to run MuleSoft software. Open a terminal on this machine.

Back on the first machine, where you installed Rancher, from the UI top nav bar click on *INFRASTRUCTURE* and then *HOSTS*.  You will see a screen that shows all registered host machines. At this point, you won’t see any registered machines.

image:add-host.png[add host]

Click on the ADD HOST button to add a host. On the next page, the Rancher UI will require that you provide a base URL that the hosts should use to connect to the server.  By default it will use the URL that your browser is currently at, which should be fine, so hit *Save* to move on to the next page.

image:add-host2.png[add host2]

There are several ways to auto-provision hosts from different cloud providers.  We will not use any of these since you have already provisioned your own server. Click on the CUSTOM icon which will give you a command to run on the host machine. Copy and paste this into your terminal to register the host with the server (this will run the Rancher agent Docker image on the host machine).  Click on *close*. Wait for a minute and go back to the host's screen and you will see that the host has been registered with the server and that it’s ready to receive commands.

image:add-host3.png[add host 3]

image:add-host4.png[add host 4]

One of the hosts you are adding to your cluster needs to be designated as the “database” host, which will ensure correct container placement for failover scenarios. Pick your designated host and open its dropdown menu by clicking on the down arrow, select “Edit” and add the following label:

[source]
----
“database” = “true”
----

image:rancher-assign-db1.png[assign db]

image:rancher-assign-db2.png[assign db2]

You can verify that the host now displays this label when viewed on the Hosts screen.

[NOTE]
Make sure that exactly *one* single host has this label attached.

image:rancher-assign-db-confirm.png[confirm active]

=== Docker Registry Setup


Although docker registries can be manually added on every host which is managed by Rancher, it’s better to add “docker.mulesoft.com” to the platform to make sure this registry exists on all nodes under Rancher control.  This way Rancher will be able to pull MuleSoft images by itself on any host without user intervention.

. In the Rancher UI, click on the icon at the top right corner of the UI and then select *Registries*

image:add-registry1.png[Select Registries]

image:add-registry2.png[Select Registries]

. Create a new “custom” registry.  You should enter Anypoint credentials that have proper permissions to pull images.

image:add-registry3.png[Custom]


. Verify that the new registry you created is now active

+
image:add-registry3.png[Verify]


To add docker registries on every host, login in each host and pull the MuleSoft images using the command line. The script `pull-docker-images.sh` included in the distribution helps to pull all images.

[NOTE]
====
We use our own internal docker registry. To download these images you will need to have the appropriate permissions added to your Anypoint account.  If you do not already have these, please contact salesops@mulesoft.com.  You will be notified when you have been given access.
====

==== OPTIONAL: Regenerate certificates, keys and keystores in the platform config

Included with both zip files available for download in this document, there's a default sent of encryption keys, self-signed certificates, and keystores that are used by the platform for security purposes such as signing certificates during mule/gateway runtime registration with the runtime manager.  Out of the box, the platform works fine using these default files, but if you wish to replace them with newly generated ones for increased security we have included a script to automate this process.

[source]
----
> cd anypoint-platform
> keystore-generation.sh
----

Follow the on-screen prompts.  Notice that once executed a new file will be generated from this process named `truststore.jks)`.  This file is required by link:/mule-agent/v/1.1.1/index[the Mule Agent] for all runtimes you wish to register to the console because the agent uses 2-way SSL validation.  Before registering a runtime, you must copy this file to the `conf/` folder of that runtime.


==== Copy platform config files to `/opt/config`

The Anypoint platform configuration files must be in a predictable location on each host machine because Rancher dynamically launches services on any available host.  This means that it won’t have the benefit of finding config files from a current working directory the same way docker-compose would.  `/opt/config` has been chosen as the default directory to store platform configuration files, so what you need to do is download the link:[I STILL NEED THE FILE TO PUT HERE] and copy the config directory into the `/opt` folder.  Repeat this procedure on every host you register to Rancher.

[source]
----
> cd anypoint-platform
> sudo cp -r config /opt/.
----


=== Upload SSL certificate

The Anypoint platform creates a load balancer which makes SSL termination. By default, the Rancher  configuration files rely on an existing SSL certificate named “mulesoft-demo”. To upload its key and certificate, on Rancher open INFRASTRUCTURE -> CERTIFICATES and click the *Add Certificate* button. Then upload or insert the key and certificates.

image:rancher-add-certificate.png[add certificate]

[NOTE]
====
If the name of your certificate is not “mulesoft-demo”, you need to modify the following line in rancher-compose.yml file:

[source, yaml]
----
nginx-ssl-lb:
  scale: 1
  default_cert: mulesoft-demo
----

====

image:rancher-add-certificate2.png[add certificate]

=== Run the platform via the Rancher UI

There are two ways of running the platform using Rancher. One of them is to use a command-line utility called `rancher-compose` (that is very similar to `docker-compose`, in case you have used it before).  This method works, but requires more steps and is more error-prone than the alternative. We recommend the second way of launching the platform, which relies entirely on the Rancher UI.  To start, click on the *Applications* link on the top nav bar and then click the *Add Stack* button.

image:rancher-add-stack.png[add stack]

Give the newly created stack a name (as a suggestion, name it `anypoint-platform`) and load the `docker-compose.yml` and `rancher-compose.yml` files available as part of either of the two .zip bundles attached at the start of this document.  It’s the equivalent of “rancher-compose create” command.

image:rancher-add-stack2.png[add stack 2]

After you do this, you can go back to the Stacks screen and you’ll be able to see all the images of the Anypoint Platform created under the stack name that you used.  These images are not running yet, but the stack has been created with the information you provided.  To run the platform, click on the *Options* icon for the stack and then select *Start Services*.

image:rancher-start-services.png[start services]

It will take several minutes for the services to come online.  The icons will slowly turn green as the services start and become ready.

image:rancher-start-services2.png[start services 2]

Once the images are all active, your Stacks screen will look like in the image below:

image:rancher-start-services3.png[start services 3]

=== Migrate and Seed databases

Now that all the services are up and running, you can run the migration and seed the authentication, object-store, and api-platform DBs.  There are two ways to do this:

. The easiest way is running the `seed-database.sh` script, available in both of the two bundle .zip files that you can download. This script runs all 3 migrations in sequence.
+
[NOTE]
This script will only work if all the services are running on 1 host.

. If the services are running on different hosts, then you should use the manual method described below.

==== Using seed-database.sh

In both .zip bundle files, there is a file named `seed-database.sh`.  Copy this file to the host machine running all the services and run it from the terminal.  It performs all necessary migrations in sequence.

==== Manual database migration and seeding

Rancher makes it easy to open a terminal window to any container via the UI, you can do that to execute the migration commands manually.

. Among your active services, find the *authentication* service.  Mouse over the running container and click the icon for the drop down menu.  Then click on *Execute Shell* to open a terminal inside the container.

+
image:rancher-execute-shell.png[execute shell]

. In the terminal window, run the following command to migrate and seed the database.  It will notify you when it’s done and report any errors.
+
[source]
----
> npm run grunt -- seedprem
----
+
image:rancher-shell1.png[shell1]

+
image:rancher-shell2.png[shell2]

. Repeat these steps with the *objectstore* service, but this time run the following command instead:

+
[source]
----
> npm run knex -- migrate:latest
----

+
image:rancher-shell3.png[shell3]

+
. Repeat the same steps with the *api-platform* service and run the same command as you did with the objectstore service:

+
[source]
----
> npm run knex -- migrate:latest
----

. Repeat the same steps with the *exchange* service and run the same command as you did with the objectstore service:

+
[source]
----
> npm run gulp -- migrate-latest
----

. Repeat the same steps with the *hybrid-rest* service to open a terminal and run this command below to seed it's database.  Do not be alarmed if the service is marked as *degraded* since that just means the database the service uses is not yet ready.

+
[source]
----
> /usr/local/bin/migrate.sh
----

. The last step is to restart the hybrid-rest service after migration so that it can validate the schema on startup and properly initialize itself.  To accomplish this, navigate the rancher ui back to the *hybridrest* service and click the *stop* button at the top to stop this service.  Once the service stops the button will change into a *start* button that you can use to restart the service.  It should come up as green and running.

Congratulations! You have now installed the Anypoint Platform running on top of Docker. You can open the service using your browser (make sure to use HTTPS) and create an organization by going to https://$HOST-IP/accounts/#/setup

=== Extending to more than 1 host

Rancher allows you to distribute containers between multiple hosts and make it absolutely transparent for clients. Scaling is quite simple:
. Make sure that you have more than 1 host for your infrastructure - you can see an example below. You can view this by accessing *Infrastructure* -> *Hosts*

+
image:rancher-multi-host.png[multi host]

+
[NOTE]
If you have only one host, scaling is still technically possible, but not very practical.

. Make sure that all configuration files for the platform exist on all hosts. You can either copy them, or preferably put on NAS and mount the share into the `/opt` folder on all hosts.
. Go to *Applications* -> *Stacks* and choose the service you want to scale.

+
[NOTE]
====
Currently not all services can be scaled. Below is a list of services you can easily multiply:

* apiplatform
* authentication
* nginx
====

. If  you need to scale the “authentication” service, as an example, you can either

+
* click on its “Scale Up” button:

+
image:rancher-scal-service.png[scale service]

* Or access its `Edit` menu:

+
image:rancher-scal-service2.png[scale service 2]

. Then use the slider to specify how many instances of the service you need:

+
image:rancher-scal-service3.png[scale service 3]

. From the remaining list of eligible hosts, the container will be scheduled on to the one with the least number of containers on it.

=== SSL termination on an external device:

If you want to make SSL encryption for Anypoint Platform traffic on an external device and don’t need an HTTPS entry point (`nginx-ssl-lb` - a default SSL load balancer) you can create an additional load balancer without SSL encryption.

. On Rancher open *APPLICATION* -> *STACK* and click the `Add Stack` button

+
image:rancher-applications-add-stack.png[add stack]

. Type name for this stack, for instance “ExternalSSL” and click *Create*

+
image:rancher-application-add-stack2.png[add stack]

. Click on the right part of *Add Service* menu and select *Add Load Balancer*

+
image:rancher-application-add-stack3.png[add stack3]

. Configure it for plain HTTP load balancing, like in the following example:
+
[width="100%",cols="50a,50a",options="header"]
|===
|*Scale* | Always run one instance of this container on every host (* recommended option)
|*Name* | http-lb
|*Description* | plain http load balancer for Anypoint Platform (* optional)
|*Source Port* | 80
|*Protocol* | tcp
|*Default Target Port* | 80
|*Access* | Public
|*Target Service* | nginx
|===

. then click *Save*
+
image:rancher-add-load-balancer.png[load balancer]

. Verify that the service is active (it may take a few minutes)

+
image:rancher-add-load-balancer2.png[load balancer]

== Hybrid Server Registration

Add a server by placing the `agent-setup-onPrem.jar` into the bin folder of mule and running the following command. Make sure to replace the token with the one from the console and also substitute the IP/DNS addresses with where your docker is running

[source]
----
> java -jar agent-setup.jar -A http://$DOCKER_IP_ADDRESS:8080/hybrid/api/v1 -W "wss://$DOCKER_IP_ADDRESS:8443/mule" -C https://$DOCKER_IP_ADDRESS/accounts -H  11111111-1111-1111-1111-111111111111---1 DESIRED_MULE_SERVER_NAME
=======

==== Copy platform config files to `/opt/config`

The Anypoint platform configuration files must be in a predictable location on each host machine because Rancher dynamically launches services on any available host.  This means that it won’t have the benefit of finding config files from a current working directory the same way docker-compose would.  `/opt/config` has been chosen as the default directory to store platform configuration files, so what you need to do is download the link:[I STILL NEED THE FILE TO PUT HERE] and copy the config directory into the `/opt` folder.  Repeat this procedure on every host you register to Rancher.

[source]
----
> cd anypoint-platform
> sudo cp -r config /opt/.
----

==== Rancher Server Installation:

Run the rancher server on the machine you designate to host it.  It occupies a single docker container.

[source]
>>>>>>> rancher-on-prem-installation
----
> sudo docker run -v /opt/anypoint-platform/config/logos/:/usr/share/cattle/war/assets/images/logos -d --restart=always -p 9999:8080 rancher/server
----

After a few minutes, the server will be running and will allow you to access the UI on your browser of choice vía HTTP:  `http://$SERVER_IP:9999`

image:rancher-welcome.png[rancher welcome]

You now have the server up and running with the Rancher UI. From here onwards, this tutorial will make use of the Rancher UI instead of the terminal to manage the installation.

==== Register a host with the rancher server:

<<<<<<< HEAD
== Identity Management Configuration

=== OpenAM Configuration (Version 12)

Below is an OpenAM configuration for running docker-compose locally (on https://anypoint.mulesoft.local)

*Identity Federation Service Provider*
[width="100%",cols="50a,50a",options="header"]
|===
|sign on url | https://ec2-52-10-207-37.us-west-2.compute.amazonaws.com:8443/openam/saml2/jsp/idpSSOInit.jsp?spEntityID=anypoint.mulesoft.local&metaAlias=/idp
|sign out url | https://ec2-52-10-207-37.us-west-2.compute.amazonaws.com:8443/openam/saml2/jsp/spSingleLogoutInit.jsp?binding=urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect&idpEntityID=anypoint.mulesoft.local&metaAlias=/idp&RelayState=http://mulesoft.com
|===

*Admin Token Provider*
[width="100%",cols="50a,50a",options="header"]
|===
|create url | https://ec2-52-10-207-37.us-west-2.compute.amazonaws.com:8443/openam/json/authenticate
|username | admin
|password | 11111
|===

*OAuth2 Authorization Provider*
[width="100%",cols="50a,50a",options="header"]
|===
|Authorize URL | https://ec2-52-10-207-37.us-west-2.compute.amazonaws.com:8443/openam/oauth2/authorize
|===

*OAuth2 Token Provider*
[width="100%",cols="50a,50a",options="header"]
|===
|Create URL |https://ec2-52-10-207-37.us-west-2.compute.amazonaws.com:8443/openam/oauth2/access_token
|===

*OAuth2 Token Validation Provider*
[width="100%",cols="50a,50a",options="header"]
|===
|Validate URL | https://ec2-52-10-207-37.us-west-2.compute.amazonaws.com:8443/openam/oauth2/tokeninfo
|Username Token Mapping |
|===

*OAuth2 Client Provider*
[width="100%",cols="50a,50a",options="header"]
|===
|Create Url | https://ec2-52-10-207-37.us-west-2.compute.amazonaws.com:8443/openam/frrest/oauth2/client/?_action=create
|Delete Url | https://ec2-52-10-207-37.us-west-2.compute.amazonaws.com:8443/openam/frrest/oauth2/client/{{client_id}}
|Scopes |cn, sn, mail, uid, givenName
|Default Scopes |cn, sn, mail, uid, givenName
|===

*SAML 2.0*
[width="100%",cols="50a,50a",options="header"]
|===
|Issuer |test.openam
|Public key |asdfasdfasdfasdfasdfasdfasfasdfasdfasdfsfas
|Audience | anypoint.mulesoft.local
|Bypass Expiration | unchecked
|Group Attribute |
|===

*SSO with an example user*

Go to `https://anypoint.mulesoft.local/accounts/login/<domain>`` (you can find the domain by clicking the ‘gear’ icon, then the *Organization* tab, and then clicking on the master organization).
Then sign in to OpenAM with your username and password.

=======
Follow the Docker instructions above on a separate machine. This machine will be used as a host to run MuleSoft software. Open a terminal on this machine.

Back on the first machine, where you installed Rancher, from the UI top nav bar click on *INFRASTRUCTURE* and then *HOSTS*.  You will see a screen that shows all registered host machines. At this point, you won’t see any registered machines.

image:add-host.png[add host]

Click on the ADD HOST button to add a host. On the next page, the Rancher UI will require that you provide a base URL that the hosts should use to connect to the server.  By default it will use the URL that your browser is currently at, which should be fine, so hit *Save* to move on to the next page.

image:add-host2.png[add host2]

There are several ways to auto-provision hosts from different cloud providers.  We will not use any of these since you have already provisioned your own server. Click on the CUSTOM icon which will give you a command to run on the host machine. Copy and paste this into your terminal to register the host with the server (this will run the Rancher agent Docker image on the host machine).  Click on *close*. Wait for a minute and go back to the host's screen and you will see that the host has been registered with the server and that it’s ready to receive commands.

image:add-host3.png[add host 3]

image:add-host4.png[add host 4]

One of the hosts you are adding to your cluster needs to be designated as the “database” host, which will ensure correct container placement for failover scenarios. Pick your designated host and open its dropdown menu by clicking on the down arrow, select “Edit” and add the following label:

[source]
----
“database” = “true”
----

image:rancher-assign-db1.png[assign db]

image:rancher-assign-db2.png[assign db2]

You can verify that the host now displays this label when viewed on the Hosts screen.

[NOTE]
Make sure that exactly *one* single host has this label attached.

image:rancher-assign-db-confirm.png[confirm active]

=== Docker Registry Setup


Although docker registries can be manually added on every host which is managed by Rancher, it’s better to add “docker.mulesoft.com” to the platform to make sure this registry exists on all nodes under Rancher control.  This way Rancher will be able to pull MuleSoft images by itself on any host without user intervention.

. In the Rancher UI, click on the icon at the top right corner of the UI and then select *Registries*

image:add-registry1.png[Select Registries]

image:add-registry2.png[Select Registries]

. Create a new “custom” registry.  You should enter Anypoint credentials that have proper permissions to pull images.

image:add-registry3.png[Custom]


. Verify that the new registry you created is now active

+
image:add-registry3.png[Verify]


To add docker registries on every host, login in each host and pull the MuleSoft images using the command line. The script `pull-docker-images.sh` included in the distribution helps to pull all images.

[NOTE]
====
We use our own internal docker registry. To download these images you will need to have the appropriate permissions added to your Anypoint account.  If you do not already have these, please contact salesops@mulesoft.com.  You will be notified when you have been given access.
====

==== OPTIONAL: Regenerate certificates, keys and keystores in the platform config

Included with both zip files available for download in this document, there's a default sent of encryption keys, self-signed certificates, and keystores that are used by the platform for security purposes such as signing certificates during mule/gateway runtime registration with the runtime manager.  Out of the box, the platform works fine using these default files, but if you wish to replace them with newly generated ones for increased security we have included a script to automate this process.

[source]
----
> cd anypoint-platform
> keystore-generation.sh
----

Follow the on-screen prompts.  Notice that once executed a new file will be generated from this process named `truststore.jks)`.  This file is required by link:/mule-agent/v/1.1.1/index[the Mule Agent] for all runtimes you wish to register to the console because the agent uses 2-way SSL validation.  Before registering a runtime, you must copy this file to the `conf/` folder of that runtime.


==== Copy platform config files to `/opt/config`

The Anypoint platform configuration files must be in a predictable location on each host machine because Rancher dynamically launches services on any available host.  This means that it won’t have the benefit of finding config files from a current working directory the same way docker-compose would.  `/opt/config` has been chosen as the default directory to store platform configuration files, so what you need to do is download the link:[I STILL NEED THE FILE TO PUT HERE] and copy the config directory into the `/opt` folder.  Repeat this procedure on every host you register to Rancher.

[source]
----
> cd anypoint-platform
> sudo cp -r config /opt/.
----

////
=== Create directories for databases

To recover Postgres databases in case of crash or failure, 2 things are necessary
* a logical dump of a database
* all WAL segments between the time of the dump and the crash moment

To simplify backup and restore process we suggest using an external storage mounted to /opt/dbs on all hosts where DB container can run. Please use the following command to create directories for all DB instances:

[source]
----
for i in /opt/dbs/objectstore /opt/dbs/auth /opt/dbs/apiplatform /opt/dbs/hybrid /opt/dbs/exchange /opt/dbs/ramlmocking /opt/dbs/backups ; do mkdir -p $i ; done
----
////

=== Upload SSL certificate

The Anypoint platform creates a load balancer which makes SSL termination. By default, the Rancher  configuration files rely on an existing SSL certificate named “mulesoft-demo”. To upload its key and certificate, on Rancher open INFRASTRUCTURE -> CERTIFICATES and click the *Add Certificate* button. Then upload or insert the key and certificates.

image:rancher-add-certificate.png[add certificate]

[NOTE]
====
If the name of your certificate is not “mulesoft-demo”, you need to modify the following line in rancher-compose.yml file:

[source, yaml]
----
nginx-ssl-lb:
  scale: 1
  default_cert: mulesoft-demo
----

====

image:rancher-add-certificate2.png[add certificate]

=== Run the platform via the Rancher UI

There are two ways of running the platform using Rancher. One of them is to use a command-line utility called `rancher-compose` (that is very similar to `docker-compose`, in case you have used it before).  This method works, but requires more steps and is more error-prone than the alternative. We recommend the second way of launching the platform, which relies entirely on the Rancher UI.  To start, click on the *Applications* link on the top nav bar and then click the *Add Stack* button.

image:rancher-add-stack.png[add stack]

Give the newly created stack a name (as a suggestion, name it `anypoint-platform`) and load the `docker-compose.yml` and `rancher-compose.yml` files available as part of either of the two .zip bundles attached at the start of this document.  It’s the equivalent of “rancher-compose create” command.

image:rancher-add-stack2.png[add stack 2]

After you do this, you can go back to the Stacks screen and you’ll be able to see all the images of the Anypoint Platform created under the stack name that you used.  These images are not running yet, but the stack has been created with the information you provided.  To run the platform, click on the *Options* icon for the stack and then select *Start Services*.

image:rancher-start-services.png[start services]

It will take several minutes for the services to come online.  The icons will slowly turn green as the services start and become ready.

image:rancher-start-services2.png[start services 2]

Once the images are all active, your Stacks screen will look like in the image below:

image:rancher-start-services3.png[start services 3]

=== Migrate and Seed databases

Now that all the services are up and running, you can run the migration and seed the authentication, object-store, and api-platform DBs.  There are two ways to do this:

. The easiest way is running the `seed-database.sh` script, available in both of the two bundle .zip files that you can download. This script runs all 3 migrations in sequence.
+
[NOTE]
This script will only work if all the services are running on 1 host.

. If the services are running on different hosts, then you should use the manual method described below.

==== Using seed-database.sh

In both .zip bundle files, there is a file named `seed-database.sh`.  Copy this file to the host machine running all the services and run it from the terminal.  It performs all necessary migrations in sequence.

==== Manual database migration and seeding

Rancher makes it easy to open a terminal window to any container via the UI, you can do that to execute the migration commands manually.

. Among your active services, find the *authentication* service.  Mouse over the running container and click the icon for the drop down menu.  Then click on *Execute Shell* to open a terminal inside the container.

+
image:rancher-execute-shell.png[execute shell]

. In the terminal window, run the following command to migrate and seed the database.  It will notify you when it’s done and report any errors.
+
[source]
----
> npm run grunt -- seedprem
----
+
image:rancher-shell1.png[shell1]

+
image:rancher-shell2.png[shell2]

. Repeat these steps with the *objectstore* service, but this time run the following command instead:

+
[source]
----
> npm run knex -- migrate:latest
----

+
image:rancher-shell3.png[shell3]

+
. Repeat the same steps with the *api-platform* service and run the same command as you did with the objectstore service:

+
[source]
----
> npm run knex -- migrate:latest
----

. Repeat the same steps with the *exchange* service and run the same command as you did with the objectstore service:

+
[source]
----
> npm run gulp -- migrate-latest
----

. Repeat the same steps with the *hybrid-rest* service to open a terminal and run this command below to seed it's database.  Do not be alarmed if the service is marked as *degraded* since that just means the database the service uses is not yet ready.

+
[source]
----
> /usr/local/bin/migrate.sh
----

. The last step is to restart the hybrid-rest service after migration so that it can validate the schema on startup and properly initialize itself.  To accomplish this, navigate the rancher ui back to the *hybridrest* service and click the *stop* button at the top to stop this service.  Once the service stops the button will change into a *start* button that you can use to restart the service.  It should come up as green and running.

Congratulations! You have now installed the Anypoint Platform running on top of Docker. You can open the service using your browser (make sure to use HTTPS) and create an organization by going to https://$HOST-IP/accounts/#/setup

=== Extending to more than 1 host

Rancher allows you to distribute containers between multiple hosts and make it absolutely transparent for clients. Scaling is quite simple:
. Make sure that you have more than 1 host for your infrastructure - you can see an example below. You can view this by accessing *Infrastructure* -> *Hosts*

+
image:rancher-multi-host.png[multi host]

+
[NOTE]
If you have only one host, scaling is still technically possible, but not very practical.

. Make sure that all configuration files for the platform exist on all hosts. You can either copy them, or preferably put on NAS and mount the share into the `/opt` folder on all hosts.
. Go to *Applications* -> *Stacks* and choose the service you want to scale.

+
[NOTE]
====
Currently not all services can be scaled. Below is a list of services you can easily multiply:

* apiplatform
* authentication
* nginx
====

. If  you need to scale the “authentication” service, as an example, you can either

+
* click on its “Scale Up” button:

+
image:rancher-scal-service.png[scale service]

* Or access its `Edit` menu:

+
image:rancher-scal-service2.png[scale service 2]

. Then use the slider to specify how many instances of the service you need:

+
image:rancher-scal-service3.png[scale service 3]

. From the remaining list of eligible hosts, the container will be scheduled on to the one with the least number of containers on it.

=== SSL termination on an external device:

If you want to make SSL encryption for Anypoint Platform traffic on an external device and don’t need an HTTPS entry point (`nginx-ssl-lb` - a default SSL load balancer) you can create an additional load balancer without SSL encryption.

. On Rancher open *APPLICATION* -> *STACK* and click the `Add Stack` button

+
image:rancher-applications-add-stack.png[add stack]

. Type name for this stack, for instance “ExternalSSL” and click *Create*

+
image:rancher-application-add-stack2.png[add stack]

. Click on the right part of *Add Service* menu and select *Add Load Balancer*

+
image:rancher-application-add-stack3.png[add stack3]

. Configure it for plain HTTP load balancing, like in the following example:
+
[width="100%",cols="50a,50a",options="header"]
|===
|*Scale* | Always run one instance of this container on every host (* recommended option)
|*Name* | http-lb
|*Description* | plain http load balancer for Anypoint Platform (* optional)
|*Source Port* | 80
|*Protocol* | tcp
|*Default Target Port* | 80
|*Access* | Public
|*Target Service* | nginx
|===

. then click *Save*
+
image:rancher-add-load-balancer.png[load balancer]

. Verify that the service is active (it may take a few minutes)

+
image:rancher-add-load-balancer2.png[load balancer]

== Hybrid Server Registration

Add a server by placing the `agent-setup-onPrem.jar` into the bin folder of mule and running the following command. Make sure to replace the token with the one from the console and also substitute the IP/DNS addresses with where your docker is running

[source]
----
> java -jar agent-setup.jar -A http://$DOCKER_IP_ADDRESS:8080/hybrid/api/v1 -W "wss://$DOCKER_IP_ADDRESS:8443/mule" -C https://$DOCKER_IP_ADDRESS/accounts -H  11111111-1111-1111-1111-111111111111---1 DESIRED_MULE_SERVER_NAME
----

== Identity Management Configuration

=== OpenAM Configuration (Version 12)

Below is an OpenAM configuration for running docker-compose locally (on https://anypoint.mulesoft.local)

*Identity Federation Service Provider*
[width="100%",cols="50a,50a",options="header"]
|===
|sign on url | https://ec2-52-10-207-37.us-west-2.compute.amazonaws.com:8443/openam/saml2/jsp/idpSSOInit.jsp?spEntityID=anypoint.mulesoft.local&metaAlias=/idp
|sign out url | https://ec2-52-10-207-37.us-west-2.compute.amazonaws.com:8443/openam/saml2/jsp/spSingleLogoutInit.jsp?binding=urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect&idpEntityID=anypoint.mulesoft.local&metaAlias=/idp&RelayState=http://mulesoft.com
|===

*Admin Token Provider*
[width="100%",cols="50a,50a",options="header"]
|===
|create url | https://ec2-52-10-207-37.us-west-2.compute.amazonaws.com:8443/openam/json/authenticate
|username | admin
|password | 11111
|===

*OAuth2 Authorization Provider*
[width="100%",cols="50a,50a",options="header"]
|===
|Authorize URL | https://ec2-52-10-207-37.us-west-2.compute.amazonaws.com:8443/openam/oauth2/authorize
|===

*OAuth2 Token Provider*
[width="100%",cols="50a,50a",options="header"]
|===
|Create URL |https://ec2-52-10-207-37.us-west-2.compute.amazonaws.com:8443/openam/oauth2/access_token
|===

*OAuth2 Token Validation Provider*
[width="100%",cols="50a,50a",options="header"]
|===
|Validate URL | https://ec2-52-10-207-37.us-west-2.compute.amazonaws.com:8443/openam/oauth2/tokeninfo
|Username Token Mapping |
|===

*OAuth2 Client Provider*
[width="100%",cols="50a,50a",options="header"]
|===
|Create Url | https://ec2-52-10-207-37.us-west-2.compute.amazonaws.com:8443/openam/frrest/oauth2/client/?_action=create
|Delete Url | https://ec2-52-10-207-37.us-west-2.compute.amazonaws.com:8443/openam/frrest/oauth2/client/{{client_id}}
|Scopes |cn, sn, mail, uid, givenName
|Default Scopes |cn, sn, mail, uid, givenName
|===

*SAML 2.0*
[width="100%",cols="50a,50a",options="header"]
|===
|Issuer |test.openam
|Public key |asdfasdfasdfasdfasdfasdfasfasdfasdfasdfsfas
|Audience | anypoint.mulesoft.local
|Bypass Expiration | unchecked
|Group Attribute |
|===

*SSO with an example user*

Go to `https://anypoint.mulesoft.local/accounts/login/<domain>`` (you can find the domain by clicking the ‘gear’ icon, then the *Organization* tab, and then clicking on the master organization).
Then sign in to OpenAM with your username and password.

>>>>>>> rancher-on-prem-installation
=== OpenAM Configuration (Version 11)

Below is OpenAM configuration for running docker-compose locally (on https://anypoint.mulesoft.local)

*Identity Federation Service Provider*
[width="100%",cols="50a,50a",options="header"]
|===
|sign on url | https://ec2-54-149-141-104.us-west-2.compute.amazonaws.com:8443/openam/saml2/jsp/idpSSOInit.jsp?spEntityID=anypoint.mulesoft.local&metaAlias=/idp
|sign out url | https://ec2-54-149-141-104.us-west-2.compute.amazonaws.com:8443/openam/saml2/jsp/spSingleLogoutInit.jsp?binding=urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect&idpEntityID=anypoint.mulesoft.local&metaAlias=/idp&RelayState=http://mulesoft.com
|===

*Admin Token Provider*
[width="100%",cols="50a,50a",options="header"]
|===
|create url | https://ec2-54-149-141-104.us-west-2.compute.amazonaws.com:8443/openam/json/authenticate
|username | admin
|password | 111111
|===

*OAuth2 Authorization Provider*
[width="100%",cols="50a,50a",options="header"]
|===
|Authorize URL | https://ec2-54-149-141-104.us-west-2.compute.amazonaws.com:8443/openam/oauth2/authorize
|===

*OAuth2 Token Provider*
[width="100%",cols="50a,50a",options="header"]
|===
|Create URL | https://ec2-54-149-141-104.us-west-2.compute.amazonaws.com:8443/openam/oauth2/access_token
|===

*OAuth2 Token Validation Provider*
[width="100%",cols="50a,50a",options="header"]
|===
|Validate URL | https://ec2-54-149-141-104.us-west-2.compute.amazonaws.com:8443/openam/oauth2/tokeninfo
|Username Token Mapping |
|===

*OAuth2 Client Provider*
[width="100%",cols="50a,50a",options="header"]
|===
|Create Url | https://ec2-54-149-141-104.us-west-2.compute.amazonaws.com:8443/openam/frrest/oauth2/client/?_action=create
|Delete Url | https://ec2-54-149-141-104.us-west-2.compute.amazonaws.com:8443/openam/frrest/oauth2/client/{{client_id}}
|Scopes | cn, sn, mail, uid, givenName
|Default Scopes | cn, sn, mail, uid, givenName
|===

*SAML 2.0*
[width="100%",cols="50a,50a",options="header"]
|===
|Issuer | test.openam
|Public key | asdfasdfasdfasdfasdfasdfasfasdfasdfasdfsfas
|Audience | anypoint.mulesoft.local
|Bypass Expiration | unchecked
|Group Attribute |
|===

*SSO with an example user*
Go to `https://anypoint.mulesoft.local/accounts/login/<domain>`` (you can find the domain by clicking the ‘gear’ icon, then the *Organization* tab, and then clicking on the master organization).
Then sign in to OpenAM with your username and password.

=== Ping Federate Configuration (Version 6.10)

Below is a PingFederate configuration for running docker-compose locally (on https://anypoint.mulesoft.local)

*Identity Federation Service Provider*
[width="100%",cols="50a,50a",options="header"]
|===
Sign on url | https://ec2-54-69-143-165.us-west-2.compute.amazonaws.com:9031/idp/startSSO.ping?PartnerSpId=anypoint.mulesoft.local
|Sign out url | https://ec2-54-69-143-165.us-west-2.compute.amazonaws.com:9031/idp/SLO.saml2
|===

*OAuth2 Authorization Provider*
[width="100%",cols="50a,50a",options="header"]
|===
|Authorize URL | https://ec2-54-69-143-165.us-west-2.compute.amazonaws.com:9031/as/authorization.oauth2
|===

*OAuth2 Token Provider*
[width="100%",cols="50a,50a",options="header"]
|===
|Create URL | https://ec2-54-69-143-165.us-west-2.compute.amazonaws.com:9031/as/token.oauth2
|===

*OAuth2 Token Validation Provider*
[width="100%",cols="50a,50a",options="header"]
|===
|Validate URL | https://ec2-54-69-143-165.us-west-2.compute.amazonaws.com:9031/as/token.oauth2
|Username Token Mapping |
|===

*OAuth2 Client Provider*
[width="100%",cols="50a,50a",options="header"]
|===
|Create Url | https://ec2-54-69-143-165.us-west-2.compute.amazonaws.com:9031/pf-ws/rest/oauth/clients
|Delete Url | https://ec2-54-69-143-165.us-west-2.compute.amazonaws.com:9031/pf-ws/rest/oauth/clients/{{client_id}}
|Username | admin
|Password | 11111
|===

*SAML 2.0*
[width="100%",cols="50a,50a",options="header"]
|===
|Issuer | dev.mulesoft.com
|Public key | asdfasdfasdfasdfasdfasdfasfasdfasdfasdfsfas
|Audience | anypoint.mulesoft.local
|Bypass Expiration | unchecked
|Group Attribute | memberOf
|===

*SSO with an example user*
Go to `https://anypoint.mulesoft.local/accounts/login/<domain>`` (you can find the domain by clicking the ‘gear’ icon, then the *Organization* tab, and then clicking on the master organization).
Then sign in to OpenAM with your username and password.

=== LDAP Configuration

Below is an LDAP configuration for running docker-compose. You can use any ldap that you want since it is now fully configurable.

*Connection*
[width="100%",cols="50a,50a",options="header"]
|===
|host |  ldap://qa2-ldap-core-services-1671615769.us-east-1.elb.amazonaws.com
|port | 3389
|Bind DN | cn=Manager,dc=muleforge,dc=org
|Password | examplepass
|connectTimeoutSeconds | 10
|operationTimeoutMs | 30000
|===

*Search Bases*
[width="100%",cols="50a,50a",options="header"]
|===
|user | ou=people,dc=muleforge,dc=org
|group | ou=groups,dc=muleforge,dc=org
|===

*DNs*
[width="100%",cols="50a,50a",options="header"]
|===
|user | uid={{username}},ou=people,dc=muleforge,dc=org
|group | cn={{groupName}},ou=groups,dc=muleforge,dc=org
|===

*Filters*
[width="100%",cols="50a,50a",options="header"]
|===
|userByUsername | (&(objectClass=inetOrgPerson)(uid={{username}}))
|userByEmail | (&(objectClass=inetOrgPerson)(mail={{email}}))
|groupByGroupName | (&(objectClass=groupOfUniqueNames)(cn={{groupName}}))
|groupsByUsername |(&(objectClass=groupOfUniqueNames)(uniqueMember=uid={{username}},ou=people,dc=muleforge,dc=org))
|===

*User Field Mappings*
[width="100%",cols="50a,50a",options="header"]
|===
|username | uid
|email | mail
|firstName | givenName
|lastName | sn
|id | entryUUID
|===

*Group Field Mappings*
[width="100%",cols="50a,50a",options="header"]
|===
|groupName | cn
|id | entryUUID
|===

== Installation Notes

Insecure properties/configuration in `authentication-server` that should be customized:

* session.secret (used to sign the session cookie)
* crypto.password (used to encrypt client’s client_secret)
* admin.client.client_secret (used for loading seed data)
* auth.saml_private_pem (used to sign saml LogoutRequest/LogoutResponse for SLO)
* https.key & https.cert (the server uses this for listening on https)

=== Resetting the Admin User's Password

. Add a password reset token into the database. For simplicity, we’ll set the value of the code to the user’s name. Please change admin to the actual username of the admin user that you created in the setup steps. Execute the following on your database host:

+
[source]
----
> docker exec -it $(docker-compose ps -q authdb | head -n 1) psql -Udocker ms_authentication -c "insert into recover_codes (user_id, recover_code) (select id, username from users where username='admin');"
----

. Enter a new password by navigating to the following link. Please change the host to the hostname you’re using for your installation. Change admin to the username of the admin user that you created in the setup steps. `https://anypoint.mulesoft.local/accounts/#/new-password?code=admin`

<<<<<<< HEAD
=== Creating a Backup and Restoring

You can backup the Postgres databases used by the Anypoint Platform. Database directories are automatically created, using an external storage mounted on `/opt/dbs` on all hosts where the database container can run.

To begin dumping data to these databases, run the following command:

[source]
----
$pg_dumpall -c -h $i -U username > DATABASE.dump
----

Here you must replace username by your actual user name and DATABASE.dump by file where data will be stored.


[TIP]
For a complete overview of the 'pg_dump' command, see link:http://www.enterprisedb.com/docs/en/8.4/pg/app-pgdump.html[PostgreSQL's documentation].


If you ever need to restore your databases from your backups, run the following command:

[source]
----
pg_resore -U username DATABASE.dump
----

Here you must replace username by your actual user name and DATABASE.dump by file where data will be stored.

[NOTE]
When executing a restore, be very careful with where you restore to, and do so following any policies your organization has in regards to backup restoring.

To open the contents of one of these databases, you can use the following command:

[source]
----
cat $DIR/DATABASE.dump | psql -U username -d DATABASE
----

=======
>>>>>>> rancher-on-prem-installation
=== API Keys

To run the rancher-compose CLI you will need to obtain API keys from the Rancher server.  Click on the icon in the top-right corner of the UI and then select *API & KEYS*.

image:rancher-api-setup.png[api setup]

On the next page, click on *Add API Key*. You will then be able to see your API access key and secret key. Copy these values somewhere safe, keep in mind that you won’t be able to see the API's secret again. After clicking *Close* you will see that you have an active API key that you can use to run rancher-compose. Also take note of the Endpoint URL, which will be of use later as well.

image:rancher-api-secret.png[secret]

image:rancher-api-active.png[active api]

==== Run the platform with rancher-compose

After having registered your API, created API keys, copied the setup files to the host, and downloaded the docker images you are now ready to run rancher-compose to get the platform up and running.

[source]
----
> cd anypoint-platform
> rancher-compose --url $URL --access-key $ACCESS_KEY --secret-key $SECRET_KEY up
----

[NOTE]
The URL, access key, and secret key are set to $URL, $ACCESS_KEY, $SECRET_KEY respectively

Go back to the rancher UI and click on the application's link at the top.  You will see that there is a new “Stack” of software called `anypoint-platform` and that the services are starting up.









////
=== Host Name (Running Natively)

If you are running Docker natively, you will connect to Anypoint Platform via `localhost`. You do need to ensure that the Anypoint Platform ports are open, and that client possess the Anypoint Platform host's IP address or network host name as described above.

[TIP]
For details on how Docker handles networking on the host OS, see the Docker link:https://docs.docker.com/articles/networking/[Network Configuration] page.

Other clients on your network can connect to your on-premise Anypoint Platform installation using the network address of the host where Anypoint Platform resides.

[[host]]
=== Host Name (Running on a Virtual Machine)

If you are running Docker on a virtual machine (as you do when using Docker Machine), you need to obtain the virtual machine's IP address. This is the IP address that you will use to connect to the Anypoint Platform instance that you will install on the virtual machine.

==== Using Docker Machine

If you are using Docker Machine, you must find out the name and IP address of your virtual machine. To obtain the machine name, open a terminal on your host machine and run:

[code, bash, linenums]
----
docker-machine ls
----

The above comand will list all of your virtual machines. By default you should see one machine named *default*. Once you know your machine's name, you can run:

[code, bash, linenums]
----
docker-machine ip default
----

This should return the IP address of a virtual machine named `default`.

==== Using a Custom Virtual Machine

If your Docker installation resides on a virtual machine that isn't created through Docker Machine (for example, you have created your own virtual machine with a Linux OS), you will probably need to login to the virtual machine to find out the IP address. If the virtual machine does not have a network interface facing the host OS, you need to create one.

For example, if you are using VirtualBox, it is possible that your virtual machine has a single network interface, used for NAT. NAT stands for Network Address Translation, which allows your virtual machine to access the Internet using the network interface on your host OS. But you need another network interface on your local machine, to enable direct network communications between the host OS and the virtual machine. After you set up this interface, you will use it to connect to your on-premise Anypoint Platform.

There are several possible ways to set up host OS-virtual OS network communication, which are beyond the scope of this document. The example below describes how to set up network communications when using the https://www.virtualbox.org/[VirtualBox] virtual machine emulator.

==== Example Using VirtualBox

If you created a virtual machine in VirtualBox, by default it will have only one network interface, used for NAT. To see whether this is the case, perform the following steps:

. In VirtualBox Manager, click the virtual machine in the left-hand list, then select *Network* from the settings.
. VirtualBox Manager displays a list of interfaces. *Adapter 1* is probably dedicated to NAT. Check if there is another active interface, and if it is attached to a **Host-only Adapter**. If this is the case, you can skip to step 6.
. If no active interfaces are attached to a Host-only Adapter, select and inactive interface, for example by clicking *Adapter 2* if it is not in use (if the virtual machine is running, you need to shut it down first).
. In the menu for the adapter that you are going to activate, select *Host-only Adapter* in the **Attached to:** drop-down menu.
. Click *OK*, then start your virtual machine. VirtualBox should create a private network on the 192.168.* range and assign an IP to your virtual machine.
. Login to your virtual machine, and check its network interfaces for the "host-only" address. For example, run:
+
[code, bash, linenums]
----
ifconfig -a | grep 192
----
+
Output should be similar to the following:
+
[code, bash, linenums]
----
inet addr:192.168.56.103  Bcast:192.168.56.255  Mask:255.255.255.0
----
+
In this example, the address for your virtual machine is 192.168.56.103.

When you install Anypoint Platform, you can connect to it from your host machine using this address. We recommend, however, that you set up a host name for the IP address, as explained below.

==== Setting Up a Host Name for Your Docker Machine

On your host system (OS X or Windows), open the `hosts` file and add the following line:

[code, bash, linenums]
----
<IP address> anypoint.mulesoft.local
----


This maps the Docker virtual machine's IP address to the URL `anypoint.mulesoft.local`.

[TIP]
On OS X, the hosts file is `/etc/hosts`; on Windows, `C:\Windows\System32\Drivers\etc\hosts`.

[NOTE]
Modifying your OS's `hosts` file only provides a network address for your virtual machine on the host OS, i.e. the OS where the `hosts` file resides. To allow other clients to connect to your Anypoint Platform installation, you should set up name resolution for your network using DNS.


=== Downloading the Anypoint Platform Docker Images

==== The Docker User

[TIP]
In these instructions, the "Docker machine" is the Linux host your Docker installation resides on.


Log in to your Docker machine as the root user, or as a user authorized to run Docker commands. In this machine, user `docker` is authorized to run Docker commands. The default password for the user is `tcuser`.

[TIP]
====
In virtual machines you can run Docker commands as a non-root user by adding the user to the `docker` group. To add a user to the `docker` group, run (as root):

[code, bash, linenums]
----
usermod -a -G docker <user>
----

Then log out and back in for the setting to take effect.
====

Running Docker commands as a non-root user is recommended for the commands for logging into Docker Hub and downloading the Docker images.

==== Downloading the Images

On your Docker machine, login to your Docker Hub account.

[code, bash, linenums]
----
docker login -e <email> -p <password> -u <username> docker.mulesoft.com
----

This creates a file with your credentials in `~/.docker/config.json` (Docker 1.7) or `~/.dockercfg` (Docker 1.6).

Uncompress the Anypoint Docker Setup .zip file to your Docker machine. The contents expand to a directory, `full-anypoint-platform`.

[TIP]
====
Docker Machine is set up to use VirtualBox https://www.virtualbox.org/manual/ch04.html#sharedfolders[shared folders] to enable file transfers between your host OS and the Docker machine. In a normal Docker Machine installation, your home folder should be shared by default to `docker-machine`, and you should see it on the Docker machine by running the `df` command. The output below shows the OS X folder `/Users` mounted on a docker-machine virtual machine.

[code, bash, linenums]
----
Filesystem                Size      Used Available Use% Mounted on
tmpfs                     1.8G    115.3M      1.6G   6% /
tmpfs                  1001.3M      2.6M    998.7M   0% /dev/shm
/dev/sda1                18.2G      8.1G      9.2G  47% /mnt/sda1
cgroup                 1001.3M         0   1001.3M   0% /sys/fs/cgroup
none                    111.0G     97.3G     13.7G  88% /Users
/dev/sda1                18.2G      8.1G      9.2G  47% /mnt/sda1/var/lib/docker/aufs
----

In this case, if the setup file resides on the host OS path `/Users/mary/anypoint-docker-setup.zip`, simply run `unzip /Users/mary/anypoint-docker-setup.zip`.

Another option is to copy the setup file to the Docker machine using `scp` or, if on Windows, `scp.exe` (included in Git for Windows) or https://winscp.net/[WinSCP]. In this case, login as user `docker`, password `tcuser`.
====

Using a terminal, navigate to the `full-anypoint-platform` directory. Here you will run the script that downloads the MuleSoft Anypoint Platform images. The script is `pull-docker-images.sh`.

Run the script as root:

[code, bash, linenums]
----
./pull-docker-images.sh
----

[TIP]
`pull-docker-images.sh` is a http://www.gnu.org/software/bash/[Bash] script. If your Linux installation does not have Bash, open the script with a text editor and modify the first line, from `#!/bin/bash` to `#!/bin/sh`.

The script should begin downloading the appropriate images. The Anypoint Platform installation weighs approximately 6 GB, so it may take a while to download.

=== Running Docker Compose

After downloading is finished, from `full-anypoint-platform` directory run:

[code, bash, linenums]
----
docker-compose up -d
----

This starts up Docker Compose and the Anypoint Platform containers. Startup can take a few minutes, during which your terminal displays startup messages. Once Docker Compose is up and running, it will occupy the terminal foreground.

NOTE: You need to disable SELinux and iptables if they are enabled on your host OS.



== Logging Into Anypoint Platform

To log in to Anypoint Platform for the first time, point your browser to the following URL:

[code, bash, linenums]
----
https://anypoint.mulesoft.local/accounts/#/setup
----

Ensure to use `https` instead of `http`, or login will not work.

NOTE: For the above address to work, you need to have set up a DNS entry with this address. For details on how to find out the IP address and set up a network host name, see <<host, above>>.

When you login to Anypoint Platform for the first time, Anypoint Platform prompts you to create an organization and user.

After you create an organization and user, to log in to Anypoint Platform you will be prompted to login using the user account you just created.

Subsequently, to login to Anypoint Platform you can go to `https://anypoint.mulesoft.local`.

At this point you can begin creating organizations, adding servers, inviting users, etc.

For details on managing API Platform, see link:/anypoint-platform-administration/index[Anypoint Platform Administration].

== Adding a Server to Your Anypoint Platform On-Prem

[[download_agent]]
=== Downloading Mule Agent for Anypoint Platform On-Prem

To add a server to your on-premise Anypoint Platform, you need to link:http://mule-agent.s3.amazonaws.com/1.2.0/mule-agent-1.2.0.zip[download] and install the agent.

. Unzip the ` mule-agent-[VERSION].zip` to the `$MULE_HOME/bin` folder.
+
[INFO]
====
The agent zip file contains these 3 files - the `amc_setup` files install the Mule agent plugin.

* `amc_setup` - Mac and Linux installation file
* `amc_setup.bat` - Windows installation file
* `agent-setup-<version>.jar` - Called by the installation files
====

You must then run it from this location after completing the required steps in API Platform, as described below.

=== Obtaining the Token for Your Server

For a full description of the steps outlined in this section, see the *Add a Server* section in link:/cloudhub/managing-applications-and-servers-in-the-cloud-and-on-premises[Managing Applications and Servers in the Cloud and On Premises].

In your Anypoint Platform on-premises Edition installation, click *Applications* in the navigation bar and select your environment. Then, select *Servers* in the left-hand menu.

Anypoint Platform provides you with a generic command to install Mule agent on a Mule server and pair the server with Anypoint Platform. This command includes a token, indicated with the `-H` parameter.

A sample command looks like:

[code, bash, linenums]
----
./amc_setup -H 9658e868-[redacted]-d84e1116b585---1 server-name
----

Copy the command to your clipboard. On the machine where your Mule server resides open a terminal and go to `$MULE_HOME/bin`. Here you should have placed your copy of the Mule agent installer (see <<download_agent,above>>).

In the `$MULE_HOME/bin` directory, paste the given command and append the following parameters:

[code, bash, linenums]
----
./amc_setup -H <token> <server name> -A http://$DOCKER_IP_ADDRESS:8080/hybrid/api/v1 -W "wss://<Anypoint Platform host>:8443/mule" -C https://<AnypointPlatform host>/accounts -F https://<Anypoint Platform host>/apiplatform
----

Where:

* `<Anypoint Platform host>`: The IP address or network host name of the machine where Anypoint Platform resides
* `<token>`: The token provided by Anypoint Platform for your server
* `<server name>`: The desired name for your server on the Anypoint Platform platform

== Basic Admin Operations with Anypoint Platform

These commands are run on the Docker machine, as root or as a user authorized to run Docker commands. On Docker Machine, user `docker` is authorized to run Docker commands (for details, see <<The Docker User,above>>).

=== Starting and Stopping Anypoint Platform On-Prem

On the Docker machine, go to the `full-anypoint-platform` directory, which contains the configuration file for Anypoint Platform on premise, `docker-compose.yml`. From this directory, run:

[code, bash, linenums]
----
docker-compose stop
----

[code, bash, linenums]
----
docker@docker-machine:/home/docker/full-anypoint-platform# docker-compose stop
Stopping fullanypointplatform_mcm_1...
Stopping fullanypointplatform_nginx_1...
Stopping fullanypointplatform_apiplatform_1...
Stopping fullanypointplatform_hybridrest_1...
Stopping fullanypointplatform_hybriddb_1...
...
----

This command sends a SIGTERM to all running containers. There is a timeout of ten seconds, after which the SIGKILL signal is sent to any remaining running containers. You can modify the timeout value with the `-t` parameter:

[code, bash, linenums]
----
docker-compose stop -t 30
----

To start all Anypoint Platform containers, use `docker-compose start`.

=== Checking Status of Docker Containers

[code, bash, linenums]
----
docker ps -a
----

The output below shows the listing for a full running Anypoint Platform on-premises Edition installation (only the first five columns are displayed).

[code, bash, linenums]
----
CONTAINER ID        IMAGE                                  COMMAND                CREATED             STATUS
4ce947f1da77        mulesoft/mcm                           "catalina.sh run"      2 days ago          Up 2 days
016733805c63        mulesoft/nginx:0.0.4                   "nginx -g 'daemon of   2 days ago          Up 2 days
e236e8814e56        mulesoft/api-platform:0.0.4            "/bin/sh -c 'npm run   2 days ago          Up 2 days
38f21e928e38        mulesoft/hybrid-rest                   "catalina.sh run"      2 days ago          Up 2 days
e7c82f3c2d0a        mulesoft/hybrid-db                     "/docker-entrypoint.   2 days ago          Up 2 days
155f1f630ae0        cogniteev/echo                         "/bin/echo -n"         2 days ago          Exited (0) 2 days ago
d07280c13367        mulesoft/cs-ui:0.0.2                   "/bin/sh -c 'cd dist   2 days ago          Up 2 days
c6a4404d8a7c        mulesoft/authentication-server:0.0.1   "/bin/sh -c 'npm sta   2 days ago          Up 2 days
e141cd747a74        kiyoto/docker-fluentd                  "/usr/local/bin/flue   2 days ago          Up 2 days
f28f7aa1bfba        mulesoft/authentication-db:0.0.1       "/docker-entrypoint.   2 days ago          Up 2 days
8b61593ba351        cogniteev/echo                         "/bin/echo -n"         2 days ago          Exited (0) 2 days ago
a7e85de09521        postgres:9.3                           "/docker-entrypoint.   2 days ago          Up 2 days
ad4384954a6d        mulesoft/object-store                  "npm start"            2 days ago          Up 2 days
dc4fa6ee2ac0        cogniteev/echo                         "/bin/echo -n"         2 days ago          Exited (0) 2 days ago
f285234e8209        mulesoft/mulesoft-shared-ng:0.0.1      "/bin/sh -c 'cd dist   2 days ago          Up 2 days
50deb5cd6763        mulesoft/object-store-db               "/docker-entrypoint.   2 days ago          Up 2 days
2cb910cc6d21        cogniteev/echo                         "/bin/echo -n"         2 days ago          Exited (0) 2 days ago
25876b80a972        cpuguy83/docker-grand-ambassador       "/usr/bin/grand-amba   2 days ago          Up 2 days
----

=== Viewing Logs

Docker stores logs in the directory `<Docker user's home>/dockerlogs`, where `<Docker user's home>` is the home directory of the user who runs Docker commands. If you are running Docker commands as user `docker` on docker-machine, the home directory is `/home/docker`.

Docker log files begin with the date they were created.

[code, bash, linenums]
----
docker@docker-machine:~/dockerlog# ls -l
total 1200
-rw-r--r--    1 root     root        252592 Aug  5 00:10 20150804_0.log
-rw-r--r--    1 root     root        588542 Aug  6 17:37 20150805_0.log
-rw-r--r--    1 root     root        381747 Aug  7 16:30 20150807.b51cbaf472f07e28d.log
----

To view the files, you can use a terminal pager such as `less`:

[code, bash, linenums]
----
less 0150807.b51cbaf472f07e28d.log
----

(Hit <Tab> after typing the first characters of the log filename for auto-completion.)

To search in the log, use `/<string>`. To scroll, use the arrows; to exit, pres `q`. Other commands are available; check this basic http://www.mcsr.olemiss.edu/unixhelp/tasks/display1.3.1.html[online reference] for details.

The `dockerlogs` directory contains logs of startup, shutdown and other events including user operations such as accessing different pages of the Anypoint Platform Web interface.

=== Obtaining Help With Docker Commands

Running `docker` without parameters prints a help message with options and commands.

[code, bash, linenums]
----
docker@docker-machine:~$ docker
Usage: docker [OPTIONS] COMMAND [arg...]
A self-sufficient runtime for linux containers.
Options:
  --api-cors-header=                   Set CORS headers in the remote API
  -b, --bridge=                        Attach containers to a network bridge
  --bip=                               Specify network bridge IP
...
----

For further details on running and handling Docker containers, see the http://docs.docker.com[Docker documentation].
////
